<!DOCTYPE html>
<html>
	<head>
		%include head.tmpl
	</head>
	<body>
	    <script>
		    var roverIP;
		    var moteID;
		    var myip;
        </script>
		<div id="wrapper">
			%include navbar.tmpl ovVersion=ovVersion, roverMode=roverMode

			<div id="page-wrapper">
	            <div class="row">
	                <div class="col-lg-12">
	                    <h1 class="page-header">Testbench</h1>
	                </div>
	            </div>


	            <div class="row">
                	<div class="col-lg-12">
		                <select class="rel_value_fld" id="myip_select" size="1">
		                    <option value="none">Select Interface...</option>
		                    % for intf in myifdict:
		                        % if myifdict[intf].has_key(2) and intf!="lo":
		                            <option value={{myifdict[intf][2][0]['addr']}}>{{intf+":"+myifdict[intf][2][0]['addr']}}</option>
		                        % end
		                        % if myifdict[intf].has_key(10) and intf!="lo":
		                            <option value={{myifdict[intf][10][0]['addr'].split('%')[0]}}>{{intf+":"+myifdict[intf][10][0]['addr'].split('%')[0]}}</option>
		                        % end
		                    % end
		                </select>
		            </div>

		            <script>
		                $( "#myip_select" ).change(function(){
		                    myip =  $(this).val();

		                    console.log('Update for myip selection: ' + myip);
		                    // Store to allow automatically selecting this rover.
		                    setCookie("selected_myip", myip);

		                    // Don't allow to reselect null option.
		                    //$("#myip_select option[value='none']").remove();
		                });
		            </script>

		        </div>

                <br>

	            <div class="row">
                	<div class="col-lg-12">
                	    <input id="rover_manual" type="text" placeholder="rover IP address">
                        <button id="addrover_btn" type="button" class="btn btn-default btn-xs">Add manually</button>
                        &nbsp;or:&nbsp;
		                <button id="discover_btn" type="button" class="btn btn-default btn-xs">Discover CoAP devices</button><br>
		                <select class="rel_value_fld" id="rover_select" size="1">
		                    <option value="none">Select rover...</option>
		                    % for rover in roverlist:
		                       <option>{{rover}}</option>
		                    % end
		                </select>
		                <button id="delrover_btn" type="button" class="btn btn-default btn-xs">Delete rover</button>

		                <script>
			                $( "#discover_btn" )
			                    .button()
			                    .click(function( event ) {
                                    $.ajax({
			                            dataType: "json",
			                            url: "/coapdiscovery",
			                            success: updateRoverList,
			                            error: errorOnAjax
			                        });
			                        console.log('Trying CoAP discovery');
			                    });
		                </script>

		                <script>
		                    $( "#addrover_btn" )
		                        .button()
			                    .click(function( event ) {
                                    newRover = $("#rover_manual").val();
                                    if(!$("#rover_select").find('option[value=\'' + newRover + '\']').length){
		                                $('#rover_select').prepend($('<option/>')
		                                 .attr("value", newRover)
		                                 .attr('selected','selected')
		                                 .text(newRover));
		                                console.log('Update for rover manual addition: ' + newRover);
		                                setCookie("added_rover", newRover);
		                            }
		                            else{
		                                console.log('Duplicate! Rover already exists in the list: ' + newRover);
		                            }
		                    });
		                </script>

		                <script>
		                    $( "#delrover_btn" )
		                        .button()
			                    .click(function( event ) {
			                        oldRover = $( "#rover_select" ).val();
			                        if( oldRover != 'none' ){
		                                $("#rover_select").find('option:selected').remove();
                                        console.log('Update for rover deletion: ' + oldRover);
		                                setCookie("deleted_rover", oldRover);
		                            }
		                            else{
		                                console.log('Error: Cannot delete selected option: ' + oldRover);
		                                console.log('Error: Cannot delete selected option: ' + oldRover);
		                            }

		                    });
		                </script>

                	</div>
                </div>

                <br>
	            <div class="row">
                	<div class="col-lg-12">
                	    <button id="motes_btn" type="button" class="btn btn-default btn-xs">Discover motes on selected rover</button>
		                <select class="rel_value_fld" id="mote_select" size="1">
		                    <option value="none">Select mote...</option>
		                </select>
		                <script>
			                $( "#motes_btn" )
			                    .button()
			                    .click(function( event ) {
			                        roverIP = $( "#rover_select" ).val();
			                        if(roverIP != null && roverIP != undefined && roverIP != 'none'){
                                        $.ajax({
			                                dataType: "json",
			                                url: "/motesdiscovery/" + myip+","+roverIP,
			                                success: updateMotesList,
			                                error: errorOnAjax
			                            });
			                            console.log('Discovering motes on rover '+ roverIP);
			                        }
			                        else{
			                            console.log('Error: No rover IP specified: '+ roverIP);
			                        }
			                    });
		                </script>
		                
		                <script>
		                    $("#mote_select").change(function() {
		                        moteID =  $(this).val()
		                        
		                        if (moteID != null && moteID != undefined && moteID != 'none') {
		                            console.log('Update for mote selection: ' + moteID);
		                            // Store to allow automatically selecting this mote.
		                            setCookie("selected_moteID", moteID);
		                            $("#testbench_link").attr("href", "/testbench/" + moteID);
		                        } else {
		                            console.log('Update for mote selection: ' + moteID);
		                            // Store to allow automatically selecting this mote.
		                            setCookie("selected_moteID", moteID);
		                            $("#testbench_link").attr("href", "/testbench");
		                        }

		                        // Don't allow to reselect null option.
		                        //$("#mote_select option[value='none']").remove();
		                    });
		                </script>



                        <script>
						    function updateRoverList(json) {
						        console.log('success');
						    }

						    function updateMotesList(json) {
						        var selectBox = document.getElementById('mote_select')
						        //remove everything from list
						        while ( selectBox.firstChild ) {
                                    selectBox.removeChild( selectBox.firstChild )
                                }
                                //get new list from json :
                                $('#mote_select').append($('<option/>').attr("value", 'none').text('Select mote...'));
                                $.each(json, function(i, option) {
                                    $('#mote_select').append($('<option/>').attr("value", option).text(option));
                                });
						        console.log('success');
						    }

						    function errorOnAjax(jqxhr, status, errorstr) {
						        var errText = (errorstr == null)
						                ? '' : ', error: ' + errorstr;
						        console.log('Ajax error: ' + status + errText);
						    }
						</script>
		            </div>
		        </div>

	        </div>
	    </div>
	</body>
</html>